{% extends "main/base.html" %}
{% load static %}
{% load tz %}

{% block title %}
تفاصيل التقييم
{% endblock %}


{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/detail.css' %}">
{% endblock %}

{% block content %}

<div class="report-container">

  <h2>تقرير التقييم الأوّلي</h2>
  <p>
  تاريخ الإرسال: {{ sent_date }}
  <br>
  الوقت: {{ sent_time }}

  <h3>بيانات المريض</h3>
    <table class="report-table">
    <tr>
        <th>الاسم الكامل</th>
        <td>
        {{ assessment.patient.user.first_name }}
        {{ assessment.patient.user.middle_name }}
        {{ assessment.patient.user.last_name }}
        </td>
    </tr>

    <tr>
        <th>البريد الإلكتروني</th>
        <td>{{ assessment.patient.user.email }}</td>
    </tr>

    <tr>
        <th>رقم الملف</th>
        <td>{{ assessment.patient.file_number }}</td>
    </tr>

    <tr>
        <th>العمر</th>
        <td>{{ assessment.patient.age }}</td>
    </tr>
    </table>


  {% with a=assessment.assessment_data.sections_answers %}

  <h3>الجزء الأول: التاريخ المرضي</h3>
  <table class="report-table">
    <tr><th>هل يفهم كلامه الغرباء؟</th><td>{{ a.strangers_understand }}</td></tr>
    <tr><th>هل سبق أخذ جلسات تخاطب؟</th><td>{{ a.speech_sessions }}</td></tr>
    <tr><th>هل سبق وكان لديه سوائل في الأذن؟</th><td>{{ a.ear_fluids }}</td></tr>
    <tr><th>هل لديه لحميات في الأنف؟</th><td>{{ a.adenoids }}</td></tr>
    <tr><th>هل لديه تاريخ في التأخر اللغوي؟</th><td>{{ a.language_delay }}</td></tr>
    <tr><th>هل سبق وتم تشخيصه باضطراب نمائي؟</th><td>{{ a.developmental }}</td></tr>

    {% if a.diagnosis_details %}
    <tr>
      <th>تفاصيل التشخيص</th>
      <td>{{ a.diagnosis_details }}</td>
    </tr>
    {% endif %}
  </table>

  <h3>الجزء الثاني: التقييم</h3>
  <p><strong>الحروف التي لا يستطيع الطفل نطقها:</strong></p>
  <ul>
    {% for letter in a.difficult_letters %}
      <li>{{ letter }}</li>
    {% empty %}
      <li>لم يتم تحديد حروف</li>
    {% endfor %}
  </ul>

  <p><strong>وصف الصور صوتيًا:</strong></p>
  {% for item in assessment.assessment_data.images %}
    <div class="image-audio-block">
      <img src="{{ item.image }}" width="280">
      {% if item.audio %}
      <audio controls>
        <source src="/media/{{ item.audio }}" type="audio/webm">
      </audio>
      {% else %}
        <p>لا يوجد تسجيل صوتي</p>
      {% endif %}
    </div>
  {% endfor %}

  <h3>الجزء الثالث: فهم وتحديد حجم المشكلة</h3>
  <table class="report-table">
    <tr><th>هل يفهم كلام الطفل خارج الأسرة؟</th><td>{{ a.outside_family }}</td></tr>
    <tr><th>هل يكرر نفس الأخطاء؟</th><td>{{ a.same_errors }}</td></tr>
    <tr><th>هل يحاول تصحيح النطق؟</th><td>{{ a.tries_correct }}</td></tr>
  </table>

  {% endwith %}
</div>

{% if assessment.status == "PENDING" %}

<div class="decision-box">
  <form method="post">
    {% csrf_token %}

    <button type="submit" name="action" value="accept" class="btn-accept">
      قبول الحالة
    </button>

    <button type="button" class="btn-reject" id="openRejectModal">
      رفض الحالة
    </button>
  </form>
</div>

<!-- Overlay -->
<div class="modal-overlay" id="rejectOverlay"></div>

<!-- Reject Modal -->
<div class="reject-modal" id="rejectModal">
  <form method="post">
    {% csrf_token %}

    <h3>سبب رفض الحالة</h3>

    <label>
      <input type="radio" name="reason" value="SPECIALIST_BUSY" required>
      عذرًا لدى الأخصائي عدد من الحالات حاليًا، اختر أخصائي آخر
    </label>

    <label>
      <input type="radio" name="reason" value="NEEDS_INPERSON">
      الحالة تحتاج تقييم حضوري مباشر
    </label>

    <label>
      <input type="radio" name="reason" value="NOT_REQUIRED">
      الحالة لا تحتاج تدخل أخصائي تخاطب
    </label>

    <div class="modal-actions">
      <button type="submit" name="action" value="reject" class="btn-confirm-reject">
        تأكيد الرفض
      </button>
      <button type="button" class="btn-cancel" id="closeRejectModal">
        إلغاء
      </button>
    </div>
  </form>
</div>

{% endif %}

{% block extra_js %}
<script src="{% static 'js/detail.js' %}"></script>
{% endblock extra_js %}


{% endblock %}
