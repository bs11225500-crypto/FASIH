{% extends "patient/base_patient.html" %}
{% load static %}

{% block title %}ููุญุฉ ุงูุชุญูู{% endblock %}

{% block patient_css %}
<link rel="stylesheet" href="{% static 'css/patient_dashboard.css' %}">
{% endblock %}

{% block patient_content %}

<div class="dashboard-container">

  <div class="dashboard-header">
    <h2>ูุฑุญุจูุง {{ user.get_full_name }}</h2>
    <p>ูุฐู ููุญุฉ ุงูุชุญูู ุงูุฎุงุตุฉ ุจู</p>
  </div>

  <div class="dashboard-grid">

    <!-- ูุงุฑุฏ ุงูููู ุงูุชุนุฑููู -->
    <div class="dashboard-card">
      <div class="card-header">
        <h3>ุงูููู ุงูุชุนุฑููู</h3>
      </div>

      <div class="card-body">
        <ul>
          <li><strong>ุฑูู ุงูููู:</strong> {{ patient.file_number }}</li>
          <li><strong>ุงูุนูุฑ:</strong> {{ patient.age }} ุณููุงุช</li>
          <li><strong>ุงูุฌูุณ:</strong> {{ patient.get_gender_display }}</li>

          {% if linked_specialist %}
            <li>
              <strong>ุงูุฃุฎุตุงุฆู:</strong>
              {{ linked_specialist.user.get_full_name }}
            </li>
          {% else %}
            <li class="muted">ูู ูุชู ุฑุจุท ุฃุฎุตุงุฆู ุจุนุฏ</li>
          {% endif %}
        </ul>

        <a href="{% url 'patient:profile' %}" class="card-link">
          ุนุฑุถ ุงูููู
        </a>
      </div>
    </div>

    <!-- ูุงุฑุฏ ุญุงูุฉ ุงูุงุณุชุดุงุฑุฉ -->
    <div class="dashboard-card {% if assessment and assessment.status == 'ACCEPTED' %}card-active{% endif %}">
      <div class="card-header">
        <h3>ุญุงูุฉ ุงูุงุณุชุดุงุฑุฉ</h3>
      </div>

      <div class="card-body">

        {% if assessment %}

          {% if last_completed_session %}
            <p class="status completed">ุชูุช ุงูุฌูุณุฉ ุงูุงุณุชุดุงุฑูุฉ</p>

            {% if last_completed_session.note %}
              <span class="hint">ุชูุช ุฅุถุงูุฉ ููุงุญุธุงุช ุงูุฌูุณุฉ</span>
            {% else %}
              <span class="hint">ุจุงูุชุธุงุฑ ููุงุญุธุงุช ุงูุฃุฎุตุงุฆู</span>
            {% endif %}

          {% elif assessment.status == "PENDING" %}
            <p class="status pending">โณ ุงุณุชุดุงุฑุชู ููุฏ ุงููุฑุงุฌุนุฉ</p>
            <span class="hint">ุณูููู ุงูุฃุฎุตุงุฆู ุจูุฑุงุฌุนุฉ ุงูุงุณุชุจูุงู ูุฑูุจูุง</span>

          {% elif assessment.status == "ACCEPTED" %}
            <p class="status accepted">ุชู ูุจูู ุงูุงุณุชุดุงุฑุฉ</p>

            {% if has_sessions %}
              <span class="hint">ุชู ุชุญุฏูุฏ ุฌูุณุฉ ุงุณุชุดุงุฑูุฉ</span>
            {% else %}
              <span class="hint">ุจุงูุชุธุงุฑ ุชุญุฏูุฏ ููุนุฏ ุงูุฌูุณุฉ ุงูุงุณุชุดุงุฑูุฉ</span>
            {% endif %}

          {% elif assessment.status == "REJECTED" %}
            <p class="status rejected">ุชู ุฑูุถ ุงูุงุณุชุดุงุฑุฉ</p>
            {% if assessment.rejection_reason %}
              <span class="hint">
                ุงูุณุจุจ: {{ assessment.get_rejection_reason_display }}
              </span>
            {% endif %}
          {% endif %}

        {% else %}
          <p class="muted">ูู ูุชู ุทูุจ ุงุณุชุดุงุฑุฉ ุจุนุฏ</p>
          <a href="{% url 'specialist:choose_specialist' %}" class="card-link">
            ุทูุจ ุงุณุชุดุงุฑุฉ
          </a>
        {% endif %}

      </div>
    </div>

    <!-- ูุงุฑุฏ ููุงูู ุงูููู -->
    <div class="dashboard-card {% if today_tasks_count > 0 %}card-active{% endif %}">
      <div class="card-header">
        <h3>ููุงูู ุงูููู</h3>
      </div>

      <div class="card-body">
        {% if today_tasks_count > 0 %}
          <p>ูุฏูู <strong>{{ today_tasks_count }}</strong> ููุงู ููููู</p>
          <a href="{% url 'tasks:daily_tasks' %}" class="card-link">
            ุนุฑุถ ุงูููุงู
          </a>
        {% else %}
          <p class="muted">ูุง ุชูุฌุฏ ููุงู ุงูููู</p>
          <span class="hint">ุณูููู ุงูุฃุฎุตุงุฆู ุจุฅุถุงูุฉ ุงูููุงู ุนูุฏ ุจุฏุก ุงูุฎุทุฉ</span>
        {% endif %}
      </div>
    </div>

    <!-- ูุงุฑุฏ ุฌูุณุงุชู -->
    <div class="dashboard-card {% if next_session or last_completed_session %}card-active{% endif %}">
      <div class="card-header">
        <h3>ุฌูุณุงุชู</h3>
      </div>

      <div class="card-body">

        {% if next_session %}
          <p><strong>{{ next_session.title }}</strong></p>
          <p class="muted">
            ๐ {{ next_session.start_time|date:"Y-m-d" }}
            {{ next_session.start_time|time:"H:i" }}
          </p>
          <p class="muted">
            ุงูุฃุฎุตุงุฆู: {{ next_session.specialist.user.get_full_name }}
          </p>

          {% if next_session.can_join %}
            <p class="status active">ุฌูุณุฉ ุฌุงุฑูุฉ ุงูุขู</p>
            <a href="{% url 'session:join_session' next_session.id %}" class="card-link">
              ุฏุฎูู ุงูุฌูุณุฉ
            </a>
          {% else %}
            <p class="status upcoming">ุฌูุณุฉ ูุงุฏูุฉ</p>
            <a href="{% url 'patient:sessions' %}" class="card-link">
              ุนุฑุถ ุฌููุน ุงูุฌูุณุงุช
            </a>
          {% endif %}

        {% elif last_completed_session %}
          <p><strong>{{ last_completed_session.title }}</strong></p>
          <p class="muted">
            ๐ {{ last_completed_session.start_time|date:"Y-m-d" }}
            {{ last_completed_session.start_time|time:"H:i" }}
          </p>
          <p class="status completed">ุงูุชูุช ุงูุฌูุณุฉ</p>

          {% if last_completed_session.note %}
            <a href="{% url 'patient:session_note_detail' last_completed_session.id %}" class="card-link">
              ุนุฑุถ ููุงุญุธุงุช ุงูุฌูุณุฉ
            </a>
          {% else %}
            <span class="hint">ุจุงูุชุธุงุฑ ููุงุญุธุงุช ุงูุฃุฎุตุงุฆู</span>
          {% endif %}

        {% elif treatment_plan and treatment_plan.status != "ACTIVE" and assessment and assessment.status == "ACCEPTED" %}
          <p class="muted">ุงูุฌูุณุงุช ุงูุนูุงุฌูุฉ ูุชุงุญุฉ ุจุนุฏ ุชูุนูู ุงูุฎุทุฉ ุงูุนูุงุฌูุฉ</p>
          <span class="hint">
            ุงูุฌูุณุฉ ุงูุงุณุชุดุงุฑูุฉ ูุฌุงููุฉุ ุฃูุง ุงูุฌูุณุงุช ุงูุนูุงุฌูุฉ ูุชุชุทูุจ ุฅุชูุงู ุงูุฏูุน
          </span>
          <a href="{% url 'patient:treatment_plan' %}" class="card-link">
            ุชูุนูู ุงูุฎุทุฉ ุงูุนูุงุฌูุฉ
          </a>

        {% elif has_sessions %}
          <p class="muted">ูุฏูู ุฌูุณุงุช ุจุงูุชุธุงุฑ ุงูุชุฃููุฏ</p>
          <a href="{% url 'patient:sessions' %}" class="card-link">
            ุนุฑุถ ุงูุฌูุณุงุช
          </a>

        {% elif assessment %}
          <p class="muted">ุชู ูุจูู ุงูุงุณุชุดุงุฑุฉ ูุจุงูุชุธุงุฑ ุชุญุฏูุฏ ุงูุฌูุณุฉ</p>

        {% else %}
          <p class="muted">ูุง ุชูุฌุฏ ุฌูุณุงุช ุจุนุฏ</p>
          <span class="hint">ุงุจุฏุฃ ุจุทูุจ ุงุณุชุดุงุฑุฉ ุฃูููุง</span>
        {% endif %}

      </div>
    </div>

    <!-- ูุงุฑุฏ ุงูุฎุทุฉ ุงูุนูุงุฌูุฉ -->
    <div class="dashboard-card {% if treatment_plan and treatment_plan.status == 'ACTIVE' %}card-active{% endif %}">
      <div class="card-header">
        <h3>ุงูุฎุทุฉ ุงูุนูุงุฌูุฉ</h3>
      </div>

      <div class="card-body">
        {% if treatment_plan %}
          <p>ุงูุญุงูุฉ: {{ treatment_plan.get_status_display }}</p>

          {% if treatment_plan.status != "ACTIVE" %}
            <span class="hint">
              ุงูุฎุทุฉ ุบูุฑ ููุนููุฉ ุญุงูููุง ูุณูุชู ุชูุนูููุง ุจุนุฏ ุงุณุชููุงู ุงูุฅุฌุฑุงุกุงุช
            </span>
          {% endif %}

          <a href="{% url 'patient:treatment_plan' %}" class="card-link">
            ุนุฑุถ ุงูุฎุทุฉ
          </a>
        {% else %}
          <p class="muted">ูุง ุชูุฌุฏ ุฎุทุฉ ุนูุงุฌูุฉ ุจุนุฏ</p>
        {% endif %}
      </div>
    </div>

  </div>
</div>

{% endblock %}
