{% extends "patient/base_patient.html" %}
{% load static %}

{% block title %}Ø¬Ù„Ø³Ø§ØªÙŠ{% endblock %}

{% block patient_css %}
<link rel="stylesheet" href="{% static 'css/patient_sessions.css' %}">
{% endblock %}

{% block patient_content %}

<div class="sessions-container">

  <!-- Header -->
  <div class="page-header">
    <h2>Ø¬Ù„Ø³Ø§ØªÙŠ</h2>
    <p class="page-subtitle">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±ÙŠØ© ÙˆØ§Ù„Ø¹Ù„Ø§Ø¬ÙŠØ©</p>
  </div>

  {# ================= EMPTY STATE ================= #}
  {% if not consultation_sessions and not therapy_sessions %}
    <div class="sessions-empty-wrapper">
      <div class="sessions-empty-card">

        {% if not assessment %}
          <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø§Øª Ø­Ø§Ù„ÙŠÙ‹Ø§</h3>
          <p class="hint">
            ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø£Ø®ØµØ§Ø¦ÙŠ ÙˆØªØ¹Ø¨Ø¦Ø© Ø§Ø³ØªØ¨ÙŠØ§Ù† Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰.
          </p>

        {% elif assessment.status == "PENDING" %}
          <h3>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø£Ø®ØµØ§Ø¦ÙŠ</h3>
          <p class="hint">
            Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±ÙŠØ© Ù‚Ø±ÙŠØ¨Ù‹Ø§.
          </p>

        {% elif assessment.status == "REJECTED" %}
          <h3>ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø©</h3>
          <p class="hint">
            {{ assessment.get_rejection_reason_display }}
          </p>
        {% endif %}

      </div>
    </div>

  {% else %}

  {# ================= Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±ÙŠØ© ================= #}
  {% if consultation_sessions %}
  <section class="sessions-section">
    <h3 class="section-title">Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±ÙŠØ©</h3>

    {% for session in consultation_sessions %}
      <div class="consultation-card clean">

        <!-- Header -->
        <div class="consultation-header">
          <h4>{{ session.title }}</h4>
          <span class="time">
            {{ session.start_time|date:"Y-m-d" }}
            {{ session.start_time|time:"H:i" }}
          </span>
        </div>

        <!-- ===== Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø±ÙŠØ¶ ===== -->
        {% if session.status == "PROPOSED" %}
        <form method="post" action="{% url 'session:respond_session' session.id %}">
          {% csrf_token %}

          <div class="actions">
            <button type="submit"
                    name="action"
                    value="accept"
                    class="btn-accept">
              Ø£ÙˆØ§ÙÙ‚
            </button>

            <button type="button"
                    class="btn-reject-outline"
                    onclick="toggleReject('{{ session.id }}')">
              Ù„Ø§ ÙŠÙ†Ø§Ø³Ø¨Ù†ÙŠ
            </button>
          </div>

          <!-- Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶ -->
          <div id="reject-box-{{ session.id }}" class="reject-box">
            <textarea name="reason"
                      placeholder="Ø³Ø¨Ø¨ Ø¹Ø¯Ù… Ù…Ù†Ø§Ø³Ø¨Ø© Ø§Ù„Ù…ÙˆØ¹Ø¯"></textarea>

            <textarea name="suggested_times"
                      placeholder="Ø£ÙˆÙ‚Ø§Øª Ù…Ù‚ØªØ±Ø­Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>

            <button type="submit"
                    name="action"
                    value="reject"
                    class="btn-reject">
              Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±ÙØ¶
            </button>
          </div>
        </form>

        <!-- ===== Ù…Ø¤ÙƒØ¯Ø© ===== -->
        {% elif session.status == "CONFIRMED" %}
          <div class="status confirmed">
            ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¬Ù„Ø³Ø©
          </div>

          {% if session.can_join %}
            {% if not session.specialist_joined %}
              <span class="muted">
                â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø®ØµØ§Ø¦ÙŠ
              </span>
            {% else %}
              <a href="{% url 'session:join_session' session.id %}"
                 class="btn-primary">
                Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¬Ù„Ø³Ø©
              </a>
            {% endif %}
          {% else %}
            <span class="muted">
              â³ Ù„Ù… ÙŠØ­Ù† ÙˆÙ‚Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ø¹Ø¯
            </span>
          {% endif %}

        <!-- ===== Ù…Ø±ÙÙˆØ¶Ø© ===== -->
        {% elif session.status == "REJECTED" %}
          <div class="status rejected">
            ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¬Ù„Ø³Ø©
          </div>

          {% if session.patient_response_reason %}
            <p class="reject-reason">
              <strong>Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶:</strong>
              {{ session.patient_response_reason }}
            </p>
          {% endif %}
        {% endif %}

      </div>
    {% endfor %}
  </section>
  {% endif %}

  {# ================= Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ø¹Ù„Ø§Ø¬ÙŠØ© ================= #}
  <section class="sessions-section">
    <h3 class="section-title">Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ø¹Ù„Ø§Ø¬ÙŠØ©</h3>

    {% if can_access_therapy_sessions and therapy_sessions %}
      {% for session in therapy_sessions %}
        <div class="therapy-card">
          <h4>{{ session.title }}</h4>
          <p>ğŸ—“ {{ session.start_time }}</p>

          {% if session.can_join %}
            {% if not session.specialist_joined %}
              <span class="muted">
                â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø®ØµØ§Ø¦ÙŠ
              </span>
            {% else %}
              <a href="{% url 'session:join_session' session.id %}"
                 class="btn-primary">
                Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¬Ù„Ø³Ø©
              </a>
            {% endif %}
          {% else %}
            <span class="muted">
              â³ Ù„Ù… ÙŠØ­Ù† ÙˆÙ‚Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ø¹Ø¯
            </span>
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      <p class="muted">
        Ø³ØªØ¸Ù‡Ø± Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ø¹Ù„Ø§Ø¬ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø¹Ù„Ø§Ø¬ÙŠØ©.
      </p>
    {% endif %}
  </section>

  {% endif %}

</div>

<script>
function toggleReject(id) {
  const box = document.getElementById("reject-box-" + id);
  if (box) {
    box.classList.toggle("show");
  }
}
</script>

{% endblock %}
