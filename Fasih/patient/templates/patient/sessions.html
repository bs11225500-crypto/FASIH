{% extends "patient/base_patient.html" %}
{% load static %}

{% block title %}ุฌูุณุงุชู{% endblock %}

{% block patient_css %}
<link rel="stylesheet" href="{% static 'css/patient_sessions.css' %}">
{% endblock %}

{% block patient_content %}

<div class="sessions-container">

  <div class="page-header">
    <h2>ุฌูุณุงุชู</h2>
    <p class="page-subtitle">ูุชุงุจุนุฉ ุงูุฌูุณุงุช ุงูุงุณุชุดุงุฑูุฉ ูุงูุนูุงุฌูุฉ</p>
  </div>

  {% if not consultation_sessions and not therapy_sessions %}
    <div class="sessions-empty-wrapper">
      <div class="sessions-empty-card">

        {% if not assessment %}
          <h3>ูุง ุชูุฌุฏ ุฌูุณุงุช ุญุงูููุง</h3>
          <p class="hint">
            ูุฑุฌู ุงุฎุชูุงุฑ ุฃุฎุตุงุฆู ูุชุนุจุฆุฉ ุงุณุชุจูุงู ุงูุงุณุชุดุงุฑุฉ ุงูุฃููู.
          </p>

        {% elif assessment.status == "PENDING" %}
          <h3>ุจุงูุชุธุงุฑ ููุงููุฉ ุงูุฃุฎุตุงุฆู</h3>
          <p class="hint">
            ุณูุชู ุชุญุฏูุฏ ุงูุฌูุณุฉ ุงูุงุณุชุดุงุฑูุฉ ูุฑูุจูุง.
          </p>

        {% elif assessment.status == "ACCEPTED" %}
          <h3>ุจุงูุชุธุงุฑ ุฌุฏููุฉ ุงูุฌูุณุฉ</h3>
          <p class="hint">
            ุชู ูุจูู ุงูุงุณุชุดุงุฑุฉ ูุณูุชู ุชุญุฏูุฏ ููุนุฏ ุงูุฌูุณุฉ ูุฑูุจูุง.
          </p>

        {% elif assessment.status == "REJECTED" %}
          <h3>ุชู ุฑูุถ ุงูุงุณุชุดุงุฑุฉ</h3>
          <p class="hint">
            {{ assessment.get_rejection_reason_display }}
          </p>
        {% endif %}

      </div>
    </div>

  {% else %}

  {#  ุงูุฌูุณุฉ ุงูุงุณุชุดุงุฑูุฉ  #}
  {% if consultation_sessions %}
  <section class="sessions-section">
    <h3 class="section-title">ุงูุฌูุณุฉ ุงูุงุณุชุดุงุฑูุฉ</h3>

    {% for session in consultation_sessions %}
      <div class="consultation-card clean">

        <div class="consultation-header">
          <h4>{{ session.title }}</h4>
          <span class="time">
            {{ session.start_time|date:"Y-m-d" }}
            {{ session.start_time|time:"H:i" }}
          </span>
        </div>

        {#  ุจุงูุชุธุงุฑ ุงููุฑูุถ  #}
        {% if session.status == "PROPOSED" %}
        <form method="post" action="{% url 'session:respond_session' session.id %}">
          {% csrf_token %}

          <div class="actions">
            <button type="submit" name="action" value="accept" class="btn-accept">
              ุฃูุงูู
            </button>

            <button type="button"
                    class="btn-reject-outline"
                    onclick="toggleReject('{{ session.id }}')">
              ูุง ููุงุณุจูู
            </button>
          </div>

          <div id="reject-box-{{ session.id }}" class="reject-box">
            <textarea name="reason"
                      placeholder="ุณุจุจ ุนุฏู ููุงุณุจุฉ ุงูููุนุฏ"></textarea>

            <textarea name="suggested_times"
                      placeholder="ุฃููุงุช ููุชุฑุญุฉ (ุงุฎุชูุงุฑู)"></textarea>

            <button type="submit"
                    name="action"
                    value="reject"
                    class="btn-reject">
              ุฅุฑุณุงู ุงูุฑูุถ
            </button>
          </div>
        </form>

        {#  ูุคูุฏุฉ  #}
        {% elif session.status == "CONFIRMED" %}
          <div class="status confirmed">ุชู ุชุฃููุฏ ุงูุฌูุณุฉ</div>

          {% if session.can_join %}
            {% if not session.specialist_joined %}
              <span class="muted">โณ ุจุงูุชุธุงุฑ ุฏุฎูู ุงูุฃุฎุตุงุฆู</span>
            {% else %}
              <a href="{% url 'session:join_session' session.id %}"
                 class="btn-primary">
                ุฏุฎูู ุงูุฌูุณุฉ
              </a>
            {% endif %}
          {% else %}
            <span class="muted">
              ๐ ููุนุฏ ุงูุฌูุณุฉ:
              {{ session.start_time|date:"Y-m-d" }}
              {{ session.start_time|time:"H:i" }}
            </span>
          {% endif %}

        {#  ููุชููุฉ  #}
        {% elif session.status == "COMPLETED" %}
          <div class="status completed">ุงูุชูุช ุงูุฌูุณุฉ</div>

          {% if session.note %}
            <a href="{% url 'patient:session_note_detail' session.id %}"
               class="btn-primary">
              ุนุฑุถ ููุงุญุธุงุช ุงูุฌูุณุฉ
            </a>
          {% else %}
            <span class="muted">โณ ุจุงูุชุธุงุฑ ููุงุญุธุงุช ุงูุฃุฎุตุงุฆู</span>
          {% endif %}

        {#  ูุฑููุถุฉ  #}
        {% elif session.status == "REJECTED" %}
          <div class="status rejected">ุชู ุฑูุถ ุงูุฌูุณุฉ</div>

          {% if session.patient_response_reason %}
            <p class="reject-reason">
              <strong>ุณุจุจ ุงูุฑูุถ:</strong>
              {{ session.patient_response_reason }}
            </p>
          {% endif %}
        {% endif %}

      </div>
    {% endfor %}
  </section>
  {% endif %}

  {#  ุงูุฌูุณุงุช ุงูุนูุงุฌูุฉ  #}
  <section class="sessions-section">
    <h3 class="section-title">ุงูุฌูุณุงุช ุงูุนูุงุฌูุฉ</h3>

    {% if can_access_therapy_sessions and therapy_sessions %}
      {% for session in therapy_sessions %}
        <div class="therapy-card">

          <div class="therapy-header">
            <h4>{{ session.title }}</h4>
            <span class="time">
              {{ session.start_time|date:"Y-m-d" }}
              {{ session.start_time|time:"H:i" }}
            </span>
          </div>

          {% if session.status == "CONFIRMED" %}
            {% if session.can_join %}
              {% if not session.specialist_joined %}
                <span class="muted">โณ ุจุงูุชุธุงุฑ ุฏุฎูู ุงูุฃุฎุตุงุฆู</span>
              {% else %}
                <a href="{% url 'session:join_session' session.id %}"
                   class="btn-primary">
                  ุฏุฎูู ุงูุฌูุณุฉ
                </a>
              {% endif %}
            {% else %}
              <span class="muted">โณ ูู ูุญู ููุช ุงูุฌูุณุฉ ุจุนุฏ</span>
            {% endif %}

          {% elif session.status == "COMPLETED" %}
            <div class="status completed">ุงูุชูุช ุงูุฌูุณุฉ</div>

            {% if session.note %}
              <a href="{% url 'patient:session_note_detail' session.id %}"
                 class="btn-primary">
                ุนุฑุถ ููุงุญุธุงุช ุงูุฌูุณุฉ
              </a>
            {% else %}
              <span class="muted">โณ ุจุงูุชุธุงุฑ ููุงุญุธุงุช ุงูุฃุฎุตุงุฆู</span>
            {% endif %}
          {% endif %}

        </div>
      {% endfor %}
    {% else %}
      <p class="muted">
        ุณุชุธูุฑ ุงูุฌูุณุงุช ุงูุนูุงุฌูุฉ ุจุนุฏ ุงุนุชูุงุฏ ุงูุฎุทุฉ ุงูุนูุงุฌูุฉ.
      </p>
    {% endif %}
  </section>

  {% endif %}

</div>

<script>
function toggleReject(id) {
  const box = document.getElementById("reject-box-" + id);
  if (box) {
    box.classList.toggle("show");
  }
}
</script>

{% endblock %}
